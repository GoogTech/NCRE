/*
 * @Author: HuangYuhui 
 * @Date: 2019-01-31 18:24:59 
 * @Last Modified by: HuangYuhui
 * @Last Modified time: 2019-02-01 12:23:57
 */

设计与应用题
1-已知某教务处管理系统的设计人员在需求分析阶段收集到下列原始数据列表 : 
教师
    '教师号'    '教师名'    '职称'      '工资'      '上级领导教师号'
    9868        王文华      教授        8000        null
    9983        李一斌      副教授      6000        9868
    9985        丁一        讲师        4000        9869
    0783        王润泽      讲师        4000        9869
    0899        欧阳丹妮    讲师        4000        9868

课程
    '课程号'    '课程名'        '学分'      '教材号'    '教材名'                 '出版社名'          '任课教师号'
     C2006      计算机原理        3          11         计算机原理             清华大学出版社           9868
     C2006      计算机原理        3          11         计算机级原理与应用      高等教育出版社           9868
     C2004      数据结构          3          11         数据结构               清华大学出版社           9868
     C2010      数据库原理        3          11         数据库原理             清华大学出版社           9868
     C2010      数据库原理        3          11         数据库原理与技术        高等教育出版社           9868
     S3001      音乐欣赏          2          11         音乐欣赏               清华大学出版社           9863

已知该业务系统存在如下规则 : 
I.每个教师有唯一的教师号,每个教师号对应唯一的一名教师;
II.每门课程有唯一的课程号,每个课程号对应着唯一的一门课程;
III.每本教材有唯一的教材号,每个教材号对应着唯一的一本教材;
IV.每个教师最多只有一个上级领导,也可以没有上级领导;
V.一门课程仅有一名教师讲授;
VI.一本教材仅用于一门课程;

问题
(1)请根据原始数据表及业务规则,给出该系统的关系模式,保证每个关系模式满足'3NF',并说明每个关系模式的主码和外码.
    '--- 解题思路 ---'
    概念 : '关系的描述称为关系模式.它可以形式化地表示为 : R(U,D,DOM,F)'
    重点 : 要想使转换生成的关系模式满足'3NF',则必须满足关系模式中每一个非主属性既不部分依赖于码也不传递依赖于码.
    思路 : 根据题目中的表中的数据和业务系统的规则可知,'共有四个实体存在,分别是 : 教师,课程,教材,职称.'职称作为实体
           而不是教师的属性是因为 : '职称与工资挂钩',考虑到其有进一步的描述特性,所以把职称作为 : '一个关系'而不是教师
           的一个属性,而且'教师号,职称,工资之间存在传递依赖,不满足3NF'.
    
    '--- 参考答案 ---'
    教师(教师号,教师名,上级领导教师号,职称)
    主码 : 教师号,外码 : 上级领导教师号,职称

    职称(职称,工资)
    主码 : 职称. 外码 : 无

    课程(课程号,课程名,学分,教材号,任课教师号)
    主码 : 课程号,外码,教材号,任课教师号

    教材(教材号,教材名,出版社)
    主码 : 教材号. 外码 : 无


(2)画出该系统的'ER图',ER图中需要给出每个实体集的属性,主码属性用下划线标识.
    '--- 解题思路 ---'
    E-R 图 : '也称实体-联系图,提供了表示实体类型,属性和联系的方法,用来描述现实世界的概念模型.'
    概念   : 为了简化E-R图的处置,现实世界的事物能作为属性对待的,尽量作为属性对待.
            矩形框 : 表示实体型,矩形框内写明实体名称;
            椭圆图框 : 表示实体的属性,并用实心线段 : 将其与相应关系的“实体型”连接起来;
            菱形框 : 表示实体型之间的联系成因,在菱形框内写明联系名,并用实心线段 : 分别与有关实体型连接起来，同时在”实心线段旁标上联系的类型 : '1:1/1:n/m:n'
            连线 : 实体与属性之间,实体与联系之间;

    实体与属性的划分给出如下两条规则 : 
        1-作为'属性',不能再具有需要描述的性质.'属性'必须是不可分的数据项.不能包含其它属性.
        2-'属性'不能与其它实体有联系,既E-R图中所表示的联系是实体之间的联系.
    
    解析 : 题目中教师与课程有'讲授关系',课程和教材有'使用关系',教师与职称有'聘用关系'.

    '--- 参考答案 ---'
    详情见 : question-1.png




/*
 * @Author: HuangYuhui 
 * @Date: 2019-02-01 10:26:49 
 * @Last Modified by:   HuangYuhui 
 * @Last Modified time: 2019-02-01 10:26:49 
 */

2-在SQL Server 2008中,设某数据库中有 : '商品表(商品号,商品名,进货价格)',商品号为主码;
  '销售表(商品号,销售时间,销售数量,销售单价,本次利润)',商品号和销售时间为主码.销售单价
  为本次销售商品的单价,先要求每当在销售表中插入前4列数据时(假设一次只能插入一行)
  系统自动计算本次销售产生的利润,并将该利润赋给销售表的第五行:'本次利润'.
  问题 : 请编写实现上述功能的后触发型触发器代码.

  '--- 解题思路 ---'
    触发器 : '触发器是用户定义在关系表上的一类由事件驱动的特殊过程.'
    触发器概念 : 触发器一旦定义,任何用户对表的增,删,改,操作均有服务器自动激活相应的触发器,在'DBMS'核心层进行集中的
                完整性控制,触发器类似于约束,但比约束更加灵活,可以实施比FOREIGN KEY约束,CHECK约束更为复杂的检查操
                作,具有更精细和强大的数据控制能力.

    注意点 : 题中已知:商品号和销售时间为主码,既而商品号+销售世家你锁定唯一商品.

    触发器的创建格式 : 
            CREATE TRIGGER [SCHEMA_NAME.]TRIGGER_NAME
            ON {TABLE|VIEW}
            {FOR|AFTER|INSTEAD OF}                          
            {[INSERT][,][UPDATE],[,][DELETE]}
            AS {SQL_STATEMENT}
            [;]

  '--- 参考答案 ---'
            CREATE TRIGGER calcu_product
            AFTER INSERT ON 销售表
            FOR EACH ROW
                AS BEGIN
                    DECLARE @PurchasePrise float                                             /* 对应商品的进价的参数 */
                    SELECT @PurchasePrise = 进货价格 FROM 商品表 WHERE 商品号 = new.商品号      /* 注意 : 商品号+销售时间锁定唯一商品 */
                    UPDATE 销售表 SET 本次利润 = new.销售数量 * (new.销售单价 - @PurchasePrise) WHERE 商品号 = new.商品号 AND 销售时间 = new.销售时间
                END
            


/*
 * @Author: HuangYuhui 
 * @Date: 2019-02-01 11:28:34 
 * @Last Modified by:   HuangYuhui 
 * @Last Modified time: 2019-02-01 11:28:34 
 */
 
 3-在进行某学校教务管理系统的数据库设计时,数据库设计人员设计了如下几个关系模式 : 
 系(系号,系名), 主码 : 系号
 学生(学号,姓名,所在系号), 主码 : 学号
 课程(课程号,课程名,开课系号), 主码 : 课程号
 选课(学号,课程号,选课时间), 主码 : 学号,课程号

开发人员在将关系模式实施到SQL Server 2008的"教务"数据库时,使用了如下表结构定义语句 : 
CREATE TABLE 系(
    系号 VARCHAR(10) NOT NULL,
    系名 VARCHAR(100)
)
CREATE TABLE 学生(
    学号 VARCHAR(50) NOT NULL,
    姓名 VARCHAR(10),
    所在系号 VARCHAR(10)
)
CREATE TABLE 课程(
    课程号 VARCHAR(50) NOT NULL,
    课程名 VARCHAR(100),
    开源系号 VARCHAR(10)
)
CREATE TABLE 选课(
    学号 VARCHAR(50) NOT NULL,
    选课号 VARCHAR(50) NOT NULL,
    选课时间 datetime
)

在执行如下查询语句时发现执行效率很低 : 
    SELECT * FROM 选课 JOIN 学生 ON 学生.学号 = 选课.学号
                          JOIN 系 ON 系.系号 = 学生.所在系号
                            JOIN 课程 ON 课程.课程号 = 选课.课程号
                                WHERE 系.系号 = '012' AND convert(VARCHAR(10),选课时间,120) >= '2010-01-01'

问题:
    (1)-在查找原因时发现建表语句有问题,请指出问题并说明该问题是否会影响此查询语句的执行效率.
    (2)-设已在选课表 : '选课时间'列及学生表 : '所在系号'列上建立索引.请问这两个索引是否能够提高该查询语句的执行效率?
        如果不能,请说明原因.
    
    '--- 解题思路 ---'
    (1)-本题中查询语句的功能是得到系号为: 12系全体学生在2010年1月1日后的选课情况的汇总表.在每个数据表的定义时都必须严格
        定义表中的 : '完整性约束条件,包括主键的设置,否则之后会出现主键由相同值的情况,破坏了数据的完整性.'

    (2)-经常出现在'WHERE'字句中的字段,特别是大表的字段,应该建立索引.另外,在SQL Server内存够用的情况下,索引会被放到内存
        中,在内存中查找自然又会提高效率,所以必须合理利用索引.

    '--- 参考答案 ----'
    (1)-建表时没有设置主键,也没有说明外键,但不会影响此查询语句指向的效率.

    (2)-选课表的'选课时间'可以建立索引,从而提高了查询效率,而学生表的'所在系号'建立索引不会提高查询的效率.
        索引的意义 : 就是将记录按目标关键字顺序排序,这样查找某个目标关键字的对应值的位置就缩小了查找范围.
        '选课时间'的重复率低,所以可以作为索引,而学生的'所在系号'的重复率太高,则不会提高查找效率.
    
