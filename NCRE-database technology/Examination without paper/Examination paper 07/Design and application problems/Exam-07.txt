/*
 * @Author: HuangYuhui 
 * @Date: 2019-02-10 09:57:33 
 * @Last Modified by: HuangYuhui
 * @Last Modified time: 2019-02-10 12:02:25
 */

设计与应用题

1-设有某商业单位需要建立商务数据库用以处理销售记账.它记录的数据包括 : 
顾客姓名,所在单位及电话号码;
商品名称,型号,产地及单价;
某顾客购买某商品的数量及日期;

假定无同名顾客,无同类型号商品,电话公用,顾客可在不同日期买同一商品.

(1)-画出该单位的商务ER图模型并优化.
(2)-将ER模型换成关系模型并规范化到3NF.

    ------ 解题思路 ------
    (1)-ER图的画法:建立相应的ER图的过程如下 : 
        1-确定实体类型 : 本题有两个实体类型,既顾客实体和商品实体.
        2-确定联系类型 : 该题中只有'顾客 —— 商品模型'.
        3-把实体类型和联系类型组合成ER图.
        4-确定实体类型和联系类型的属性 : 
            顾客实体集属性 : 姓名,单位,电话号码.
            商品实体集属性 : 型号,名称,产地,单价.
        
        总结 : 由于顾客和商品两个实体为 : 顾客——商品 购买关系,并且根据实体的属性可以画出相应的ER图.
    
    (2)-ER模型转换为关系模式的规则.
        1-把ER模型中的每一个实体集转换为同名的关系,实体集的属性就是关系的属性,实体集的码就是关系的码.
        2-把ER模型中的每一个联系转换成一个关系,与该联系相连的各实体集的码以及联系的属性转换为关系的属性.
        3-合并具有相同码的关系.

        总结 : 本题中从ER模型转换成关系模型,由两个实体和一个关系分别转换成 : 三个关系模式.


    ------ 参考答案 ------
    (1)-详情见 : question-0701.png

    (2)-将ER模型转换为关系模型,并规范到3NF.
        顾客(姓名,单位,电话号码),           主键 : 姓名
        商品(型号,名称,单价,产地),          主键 : 型号
        购买(姓名,型号,数量,日期),          主键 : 姓名 + 型号

        注: 因为转换过来的关系模式中,不存在属性依赖于其他非主属性,因此对转换的结果不需要优化.






2-设在采用SQL Server 2008 数据库的图书馆应用程序系统中有三个基本表,表结构如下所示,请用SQL语句完成下列两个查询.
BORROWER : 
            借书证号        姓名        系名        班级
            12011106       NAME-1      计算机系     12-1
            12011107       NAME-2      计算机系     12-1
            12012113       NAME-3      信息系       12-2
            ······

LOANS : 
            借书证号        图书馆登记号        借书日期    
            12011106        T001001            2012.01.02
            12012113        T001026            2012.02.06
            ······

BOOKS : 
            索书号      书名          作者        图书馆登记号      出版社      价格
            TP311.1     数据库系统    NAME-1      T001001        科学        xx.x
            TP311.2     二级C语句     NAME-2      T001026        人民        xx.x

(1)-检索至少借了五本书的同学的借书证号,姓名,系名,和借书数量.
(2)-检索和王丽同学所借图书中的任意一本相同的学生姓名,系名,书名和借书日期.

    ------ 解题思路 ------
    (1)-采用两表联合插叙,以两表'借书证号'为相等条件,在结果集中用'GROUP BY'按照借书证号来分类,
        并且用'HAVING'关键字统计出符合条件的记录数.

    (2)-采用'IN'关键字对两表联合查询,在BORROWER和LOANS联合的结果集中查找满足第三个表指定的条件.

    ------ 参考答案 ------
    (1)-
        SELECT LOANS.借书证号,姓名,系名,COUNT(*) AS 借书数量
            FROM BORROWER,LOANS
                WHERE BORROWER.借书证号 = LOANS.借书证号
                    GROUP BY LOANS.借书证号 HAVING COUNT(*) >= 5;   /*Attention : HAVING COUNT(*)>=5 */

    (2)-
        SELECT 姓名,系名,书名,借书日期
            FROM BORROWER,LOANS,BOOKS
                WHERE BORROWER.借书证号 = LOANS.借书证号 AND LOANS.图书馆登记号 = BOOKS.图书馆登记号
                AND 索书号 IN
                (
                    SELECT 索书号 FROM BORROWER,LOANS,BOOKS
                        WHERE BORROWER.借书证号 = LOANS.借书证号 AND LOANS.图书馆登记号 = BOOKS.图书馆登记号
                        AND 姓名 = "王丽"
                )





3-在SQL Server 2008中,设有教师表(教师号,姓名,所在部门号,职称)和部门表(部门号,部门名,高级职称人数).
请编写满足下列要求的后触发型触发器(设触发器名为 : trigger_zc).

问 : 每当教师表插入一名具有高级职称('教授'/'副教授')的教师时,或者将非高级职称教师的职称改为高级职称时,
均修改部门表中相应的高级职称人数.(假设一次操作只插入或更改一名教师的职称).

    ------ 解题思路 ------
    创建触发器的SQL语句为 : 
    CREATE TRIGGER [schema_name.]trigger_name
    ON {table|view}
    {FOR|AFTER|INSTEAD OF}
    {[INSERT][,][DELETE][,][UPDATE]}
    AS {sql_statement}
    [;]

    思路 : 
    其中'AFTER'指定触发器为后触发型触发器,INSERT,UPDATE和DELETE为指定引发触发器执行的操作,根据原题要求,INSERT
    触发器会在'inserted'表中添加一条刚插入的记录,'Update'触发器会在更新数据后将更新前的数据保存在'deleted'表
    中,更新后的数据保存在'inserted'表中,在教师表中插入或者更新的时候,都会在'inserted'表中增加一条记录,所以只
    需要在触发器查询'inserted'表中查询有没有教授/副教授的记录,如果有,则触发修改相应部门的高级职称人数即可.

    ------ 参考答案 ------ 
    CREATE TRIGGER trigger_zc
    ON 教师表
    AFTER INSERT,UPDATE
    AS
        BEGIN
            DECLARE @zc VARCHAR(10),@dept VARCHAR(30)
            SELECT @dept = 所在部门号,@zc = 职称 FROM inserted      /* ATTENTION : inserted */
                IF @zc = '教授' or '副教授'
                UPDATE 部门表 SET 高级职称人数 = 高级职称人数 + 1 WHERE 部门号 = @dept
        END