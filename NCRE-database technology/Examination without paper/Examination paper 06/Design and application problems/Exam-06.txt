/*
 * @Author: HuangYuhui 
 * @Date: 2019-02-09 11:39:12 
 * @Last Modified by: HuangYuhui
 * @Last Modified time: 2019-02-09 16:07:39
 */

程序与应用题

1-设有高校选课系统,需要对学校的系信息,教师信息,课程信息,学生信息,学生选课信息进行管理.已知系(DEPT)信息包括系编号(DeptNO),
系名称(DeptName).教师(Teacher)信息包括教师号(TNO),教师名(Tname).课程(Course)信息包括课程号(CNO),课程名(CName),
课程学分(Credit).学生(Student)信息包括学号(SNO),学生姓名(Sname),学生性别(Sex).

选课系统的管理规则如下 : 
I.一个系可聘用多名教师,一个教师只受聘于一个系;
II.一个系可有多名学生,一个学生只属于一个系;
III.一名教师可讲授多门课程,一门课程可由多名教师讲授;
IV.一名学生可选修多门课程,一门课程可被多名学生选修;
V.学生选修完课程后,可获得相应课程的成绩;

针对以上的描述,完成下列设计内容 : 
(1)-构建选课系统的ER图,(要求图中的实体集名用试卷给出的英文名,联系所关联的实体集名的首字母,字母间用'-'或'_'连接,大小写不限)

(2)-根据所构建的ER图,设计满足3NF的关系模式,并标出每个关系模式的主码和外码.
    (要求关系模式名同实体集名或联系名,属性名用试卷给出的英文名,大小写不限)

    ------ 解题思路 ------
    (1)-建立相应的ER图的过程如下:
        1-确定实体.
        2-确定联系类型.
        3-把实体类型和联系类型组合成ER图.
        4-确定实体类型和联系类型的属性.
    
    (2)-ER模型转换为关系模式的规则.
        1-把ER模型中的每一个实体集转换为同名的关系,实体集的属性就是关系的属性,实体集的码就是关系的码.
        2-把ER模型中的每一个联系转换成一个关系,与该联系相连的各实体集的码以及联系的属性转换为关系的属性:
          关系的码根据下列情况确定: 
            1.若联系为 : 1:1 则每个实体集码均是该关系的候选码.
            2.若联系为 : 1:n 则关系的码为n端实体集的码.
            3.若联系为 : m:n 则为各实体集码的组合或其中一部分实体集码的组合.
        3-合并具有相同码的关系,根据规则,把一个ER模型转化为关系模式,一般经历下面两个步骤 :
            第一:标识ER模型中的联系.
            第二:依次转换与每个联系相关联的实体集及联系.

    ------ 参考答案 ------
    (1)-详情将 : question-06.png

    (2)-DEPT(DeptNo,DeptName),          主码 : Deptno,    外码:无
        Teacher(TNO,TName,DeptNO),      主码 : TNO,       外码:无
        Student(SNO,SName,Sex,DeptNO),  主码 : SNO,       外码:DeptNO
        Course(CNO,CName,Credit),       主码 : CNO,       外码:无
        T-C(TNO,CNO),                   主码(TNO,CNO),    外码:TNO,CNO
        S-C(SNO,CNO,成绩),              主码(SNO,CNO),    外码:SNO,CNO

        


/*
 * @Author: HuangYuhui 
 * @Date: 2019-02-09 14:36:45 
 * @Last Modified by:   HuangYuhui 
 * @Last Modified time: 2019-02-09 14:36:45 
 */

 2-某书店采用了SQL Server 2008数据库管理系统,该书店有一个需求,需要统计指定年份中每一本书的销售总额,例如:查询2012年所有书的销售总额.
 已知图书结构如下 : 
 图书表(书号 BOOK_ID,书名 BOOK_NAME,单价 BOOK_PRICE)
 销售表(书号 BOOK_ID,销售时间 SALE_TIME,销售数量 SALE_NUM)
 假设单价和销售数量均为int型,书号和书名均为VARCHAR(50)类型,销售时间为DATETIME类型,请给出满足如下要求的多语句表值函数,该函数统计指定
 年份中每本书的销售总额.
 设函数名 : BOOK_PROFIT(@year int),该函数的返回结果格式如下 :
 
 书号       销售总额
 B001       60000
 A004       50000
 ······

    ------ 解题思路 ------
    采用JOIN联合查询,先用WHERE条件查询出符合销售时间:'=@year'的记录,再将找出的记录和图书表合并,并采用:'单价 * 销售数量'计算
    出联合查询的表数据,最后根据:'GROUND BY'统计每种书籍的销售价格总和.

    ------ 参考答案 ------
    CREATE FUNCTION BOOK_PROFIT(@year int)
    RETURNS @f_BOOK_PROFIT table
    (
        BOOK_ID VARCHAR(50),
        PROFIT INT
    )
    AS 
        BEGIN
            INSERT INTO @f_BOOK_PROFIT
                SELECT a.BOOK_ID,SUM(a.BOOK_PRICE * b.SALE_NUM)         /* Attention : SUM(a.BOOK_PRICE * b.SALE_NUM) */
                    FROM BOOK a JOIN SALE b ON a.BOOK_ID = b.BOOK_ID
                        WHERE year(b.SALE_TIME) = @year                 /* Attention : year(b.SALE_TIME) = @year */
                            GROUND BY a.BOOK_ID
            RETURN
        END




/*
 * @Author: HuangYuhui 
 * @Date: 2019-02-09 15:00:25 
 * @Last Modified by:   HuangYuhui 
 * @Last Modified time: 2019-02-09 15:00:25 
 */

 3-某网上商城因为业务发展,原有的系统不能很好的满足需要,因此采用了一套新的经营关系系统,此系统使用SQL Server 2008数据库管理系统.
 此系统上线运行前,需将商城原有的数据导入到新得系统中.原有系统使用SQL Server 2000,数据结构与新系统不完全一致.因此需要从SQL Server
 2000 导入到SQL Server 2008中,为了保证数据一致性,数据导入过程中要求暂停业务且必须在三个小时内完成.

 (1)-在原有数据导入新系统的过程中,实施人员发现原有数据量很大,导入数据库需要四小时,业务无法接受.经分析某工程师认为,数据导入过程中
     数据I/O很高,但导入数据的程序本身对系统资源占用率很低,该工程师建议将数据导入过程中的数据恢复模式从'完整'模式改为'简单'模式以提高
     数据导入速度.而另一位工程师则认为此方法未必能提高数据导入速度,而且还可能导致数据丢失,不建议使用此方法.
     问 : 请分析此方法是否能够提高数据导入速度并给出理由,同时分析此操作的数据丢失风险.

 (2)-在成功导入历史数据后,此系统顺利上线运行,在上线运行的第一周,发现数据库服务器的CPU使用率很高,达到近90%,高峰期达到100%,且系统内存
     占用率达到90%,但系统'I/0'很轻,业务人员反应系统操作速度很慢,为了提高系统运行速度,在不修改应用程序的前提下,两位工程师提出了不同的
     解决方法 : 
     I-为服务增加2颗CPU,缓解CPU使用率很高的问题;
     II-为服务器增加一倍内存,缓解内存使用率很高的问题;
     问 : 考虑成本,现阶段只能按照一种方案实施,请指出在现有情况下,那种方案更合理并给出理由.
        
        ------ 解题思路 ------
        (1)-SQL Server 2008 的数据恢复模式有三种 : 
            1-简单恢复模式
                此方法可以最大幅度减少事物日志的管理开销,因为恢复模式不备份事物日志.但是如果数据库损坏,则简单恢复模式将面临
                极大的数据丢失风险.在这种恢复模式下,数据只能恢复到最新备份状态,因此对于用户数据库,简单恢复模式只适用于测试和
                开发数据库,或用于主要包含只读数据的数据库.
            2-完整恢复模式
                此方法可以完整的记录所有事务,并将事务日志记录保留到对其备份完毕为止.此方法相对简单恢复模式来说,更占用时间.
            3-大容量日志恢复模式
                此方法只对大容量操作进行最小记录,使事务日志不会被大容量加载操作所填充.

        总结 : 在数据库导入过程中,所有的业务都是暂停的,因此可以采用简单恢复模式提高数据导入速度,且只在数据导入的过程中暂时的
               修改恢复模式,因此数据并不会丢失.

        (2)-提高数据库性能的方法一般是从以下方面来改变数据库的参数 :
            1-外部资源
            2-调整内存分配
            3-调整磁盘I/O
            4-调整竞争资源
            而SQL Server 2008采用 : '数据库缓冲在内存的方式' 因此在数据库系统运行的过程中会占用一定的内存.
            又因为I/0并不存在问题,说明内存尚满足需求.CPU使用率很高,表明CPU的计算能力不足,应该增加CPU数量.

        ------ 参考答案 ------
        (1)-此方法能够提高数据导入速度.
            原因 : 此系统I/O很高,修改恢复模式后,系统最大限度减少日志开销,可提高导入速度.
            由于仅在数据导入过程中修改恢复模式,所以并无数据丢失风险.

        (2)-第一种方案比较合理.
            原因 : 'SQL Server 2008采用将数据缓冲在内存的方式,因此内存的使用率比较高是正常情况'.
            且现阶段'I/O'并不存在问题,表明内存满足需求,此阶段CPU使用率很高,表明CPU计算资源不足,
            因此增加CPU数量对解决问题有效.
        