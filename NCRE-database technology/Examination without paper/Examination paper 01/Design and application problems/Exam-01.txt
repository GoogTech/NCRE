/*
 * @Author: HuangYuhui 
 * @Date: 2019-01-29 11:21:44 
 * @Last Modified by: HuangYuhui
 * @Last Modified time: 2019-01-31 15:28:00
 */
 
设计与应用题

1-设某教学管理系统,其查询模块需要提供如下功能;
I: 查询系信息,列出各系编号,系名好系办公电话;
II: 查询教师信息,列出教师号,教师名,工资和聘用日期;
III: 查询某教师讲授的课程信息,列出课程号,课程名和学分;
IV: 查询讲授某门课程的教师信息,列出教师名和职称;
V: 查询讲授某门课程的先修课信息,列出先修课程号和先修课程名;

系统有如下业务规则:
I: 一个系可聘用多名教师,一名教师只能受聘于一个系;
II: 一名教师可讲授多门课程,一门课程可由多名教师讲授;
III: 一门课程可以有多门先修课程,也可以没有先修课程;

问题:
(1) 请根据以上查询功能与业务分析规则,用ER图描述该系统的概念模型;
    '--- 解 ---': 
    详情见 'question-1.png'.

(2) 将ER图转换为满足3NF的关系模式,并说明每个关系模式的主码和外码;
    '--- 解 ---': 
        系(系编号,系名,系办公室电话),无外码
        教师(教师号,教师名,职称,工资,聘用日期,系编号),外码: '系编号'
        先修课程(先修课程号,先修课程名)
        课程(课程号,课程名,学分,先修课程号),外码: '先修课程号'
        讲授(教师号,课程号)
    
    '--- 解析 ---':
        [
            由于本题目要求满足'3NF'范式,'ER'图向关系模式转换采用方法一:'关系名采用实体名或联系名'
            
            (1)本题中有两个一对多,一个多对多联系,因此在转换时一对多联系转换为:'独立的关系模式';
            '独立的关系模式':
                模式的属性由联系本身的属性以及两个实体的键构成.主键由多端实体的键组成.

            (2)m:n(多对多)联系转换成: '新的独立模式'
            '新的独立模式':
                模式的属性由联系本身的属性及两个实体的键构成,主键由两端实体的键组合而成.
        ]
        

/*
 * @Author: HuangYuhui 
 * @Date: 2019-01-31 13:18:42 
 * @Last Modified by: HuangYuhui
 * @Last Modified time: 2019-01-31 14:39:46
 */
2-设有商品表(商品名,商品号,单价)和销售表(销售单据号,商品号,销售时间,销售数量,销售单价).
  其中,商品号代表一类商品.商品号,单价,销售数量和销售单价均为整型.
  请编写查询某年某商品的销售毛利的存储过程 : '毛利 = 销售数量 x (销售单价-单价)'
  要求 : '商品号'和'年份'为输入参数,总毛利用输出参数返回.

    '--- 解析 ---'  : 
    存储过程是由'PL/SQL'语句书写的过程,这个过程经编译和优化后存储在数据库服务器中,既而使用时只需要调用即可.
    方便实施企业规则,当企业规则发生变化时只要修改存储过程,而无需修改其它应用程序.
    优点 : 
        1-其已经编译和优化过.所以运行效率高.提供了在服务器端快速执行SQL语句的有效途径.
        2-存储过程降低了客户端和服务器之间的通信量.

    '--- 创建存储过程语法 ---' :
    CREATE PROCEDURE 过程名            /* '过程名是数据库服务器合法的对象标识' */
    @[参数名][类型名],@[参数名][类型]    /* '参数列表: 用名字来标识调用时给出的参数值,必须指定值的数据类型. 参数: 输入参数/输出参数.默认: 输入参数' */
    AS
        Declare                        /* 'AS 下面对应的 <PL/SQL> 块为过程体' */
        ······
        Begin
        ······
        End

    '--- 参考答案 ---'
    CREATE PROCEDURE PRODUCT 
    @商品号 int,@年份 int,@毛利 int ouput                     /* 默认为输入参数 */
    AS
        DECLARE
        @某商品销量 int,@某商品进价 int,@某商品销售单价 int     /* 定义中间变量 */
        BEGIN
        SELECT @某商品进价 = 单价 FROM 商品表 WHERE @商品号 = 商品号
        SELECT @某商品销售单价 = 销售单价,@某商品销售量 = COUNT(*) FROM 销售表 WHERE @商品号=商品号 AND 销售时间=@年份      /* 输入参数: 商品号,年份 */
        IF @某商品进价 is NULL THEN                           /* 判断该商品是否存在 */
            ROLLBACK;
            RETURN;
        END IF
        IF @某商品销售单价 is NULL THEN                        /* 判断该商品是否可卖 */
            ROLLBACK;
            RETURN;
        IF @毛利 = (@某商品销售单价-@某商品进价) * @某商品销售量
    GO                                                        //Where are you going ?


/*
 * @Author: HuangYuhui 
 * @Date: 2019-01-31 15:07:22 
 * @Last Modified by:   HuangYuhui 
 * @Last Modified time: 2019-01-31 15:07:22 
 */
3-设首全国性的运输企业建立了大型OLTP系统,并在该系统上建立了数据仓库.OLTP系统和数据仓库中有如下数据表 :
    运输明细表(运输单ID,发送站ID,终到站ID,货物ID,货物重量,运输价格,发货日期)
    汇总表1(发送站ID,终到站ID,货物ID,发货日期,总重,总运价)
    汇总表2(发送站ID,终到地区ID,货物ID,发货日期,总重,总运价)
    汇总表3(发送站ID,终到站ID,货物ID,发货月份,总重,总运价)
    汇总表4(发送站ID,终到地区ID,货物类别ID,发货日期,总重,总运价)
    
    问题 : 
    该企业管理的货运站约有1000个,货物约有500种共10类,个汇总表都建立主码,且各表有合理的维护策略.在每次
    维护后数据能保持一致.设有视图V,该视图的访问频率很高,其查询结果模式为 :'(发送地区ID,终到站ID,发送月份,总重,总运价)'.
    该视图现以总汇表1为计算数据源.经监控发现,汇总表1的访问频率过高,导致系统整体性能下降,而其它汇总表被访问频率过低,在不
    增加汇总表和'索引'的的情况下,请给出一个改善系统服务性能的优化方案,并简要说明理由.

    '--- 解析视图的含义 ---'
    1:  从用户角度出发
        一个视图是从一个特定的角度来查看数据库中的数据.从数据库系统内部来看,一个视图是由'SELECT'语句
        组成的查询定义的虚拟表.
    2:  从数据库系统内部出发
        视图是由一张或多张表中的数据组成.
    3:  从数据库外部出发
        视图就如同一张表一样,对表能够进行的一般操作都可以应用于视图,如查询,插入,修改,删除操作等.


    '--- 参考答案 ---'
    1:  由于总汇表1和视图的模式访问频率都很高,而且视图的数据源来自汇总表1,又因为其他汇总表的访问率很低.
        所以只需要将视图的数据源绑定为汇总表3,因为汇总表3也可以满足视图的输出模式,这样不仅提升了汇总表3
        的数据访问率,而且降低了汇总表的1的数据源.继而系统性能和服务性能得到很大的变化.
    2:  又因为货物约有500种,共10类,可以再建立一个视图绑定数据源为汇总表4,这样就可以充分利用汇总表4的数
        据信息,从而进一步优化系统性能.
    
    